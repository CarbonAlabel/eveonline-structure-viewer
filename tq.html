<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Structure viewer</title>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.6/angular.min.js"></script>
<script>
const app=angular.module("viewer",[]);

// TQ
const eveConf = {
	crestRoot:"https://crest-tq.eveonline.com",
	esiRoot:"https://esi.tech.ccp.is",
	esiDatasource:"tranquility",
	ssoRoot:"https://login.eveonline.com",
	ssoClient:"24700340bf7449c0a06e885bb5351f35",
	ssoScopes:["corporationStructuresRead","esi-universe.read_structures.v1","esi-corporations.read_structures.v1"],
	ssoRedirect:"https://taabe.net/dev/projects/structureViewer/tq.html"
};

app.controller("main",function($http) {
	this.structures=[];
	this.structureNames=new Map();
	this.structureTypes=new Map();
	this.structureGroups=new Map();
	this.structureGroups.set(0,"");
	
	this.timeNow=Date.now();
	this.timeRemaining=t=>{
		let fueledForHours=(Date.parse(t+"Z")-this.timeNow)/(1000*3600);
		let timeRemainingString="";
		let localTimeString=new Date(t+"Z").toLocaleString();
		
		if(fueledForHours<0) timeRemainingString="Fuel has already expired!";
		else if(fueledForHours<1) timeRemainingString="Fuel expires in less than an hour!";
		else if(fueledForHours<48) timeRemainingString=`Fuel expires in ${Math.floor(fueledForHours)} hours.`;
		else timeRemainingString=`Fuel expires in ${Math.floor(fueledForHours/24)} days.`;
		
		return `${timeRemainingString} (${localTimeString} local time)`;
	};
	
	let get=(url,headers)=>$http.get(url,{headers:headers});

	let token=window.location.hash.match(/access_token=(.+?)\&/);
	if(!token){
		window.location=`${eveConf.ssoRoot}/oauth/authorize?response_type=token&client_id=${eveConf.ssoClient}&scope=${eveConf.ssoScopes.join("%20")}&redirect_uri=${eveConf.ssoRedirect}`;
	}
	else{
		let authHeaders={Authorization:`Bearer ${token[1]}`};
		//ESI doesn't currently provide precise fuel expiry info: https://github.com/ccpgames/esi-issues/issues/516
		//Still going to use CREST for now.
		//let structureList=get(`${eveConf.esiRoot}/verify/?datasource=${eveConf.esiDatasource}`,authHeaders).
		//then(r=>get(`${eveConf.esiRoot}/v4/characters/${r.data.CharacterID}/?datasource=${eveConf.esiDatasource}`)).
		//then(r=>get(`${eveConf.esiRoot}/v1/corporations/${r.data.corporation_id}/structures/?datasource=${eveConf.esiDatasource}`,authHeaders));
		let getStructureList=get(eveConf.crestRoot).
		then(r=>get(r.data.decode.href,authHeaders)).
		then(r=>get(r.data.character.href)).
		then(r=>get(r.data.corporation.href)).
		then(r=>get(r.data.structures,authHeaders));
		
		getStructureList.then(r=>{
			r.data.items.forEach(structure=>{
				this.structureNames.has(structure.id) || this.structureNames.set(structure.id,`Structure #${structure.id}`);
				get(`${eveConf.esiRoot}/v1/universe/structures/${structure.id}/?datasource=${eveConf.esiDatasource}`,authHeaders).then(r=>{
					this.structureNames.set(structure.id,r.data.name);
				});
			
			});
			r.data.items.forEach(structure=>{
				if(!this.structureTypes.has(structure.type.id)){
					this.structureTypes.set(structure.type.id,{name:"",size:0,group:0});
					get(`${eveConf.esiRoot}/v3/universe/types/${structure.type.id}/?datasource=${eveConf.esiDatasource}`).then(r=>{
						this.structureTypes.get(structure.type.id).name=r.data.name;
						this.structureTypes.get(structure.type.id).size=r.data.dogma_attributes.find(e=>e.attribute_id==1547).value;
						let group=r.data.group_id;
						this.structureTypes.get(structure.type.id).group=group;
						if(!this.structureGroups.has(group)){
							this.structureGroups.set(group,"");
							get(`${eveConf.esiRoot}/v1/universe/groups/${group}/?datasource=${eveConf.esiDatasource}`).then(r=>{
								this.structureGroups.set(group,r.data.name);
							});
						}
					});
				}
			});
			this.structures=r.data.items;
		});
	}
	
});
</script>
</head>
<body ng-app="viewer" ng-controller="main as main" style="font-family:sans-serif;">
<div ng-repeat="structure in main.structures">
<h2>{{main.structureNames.get(structure.id)}}</h2>
<p>{{main.structureTypes.get(structure.type.id).name}} - {{["","Small","Medium","Large","Extra Large"][main.structureTypes.get(structure.type.id).size]}} {{main.structureGroups.get(main.structureTypes.get(structure.type.id).group)}}</p>
<p>{{structure.fuelExpires?main.timeRemaining(structure.fuelExpires):"Fuel info N/A"}}</p>
</div>
</body>
</html>
